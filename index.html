<!DOCTYPE html>

<html>
    <head>
        <meta charset="utf-8">
        <title>Flicker Gallery</title>
        <style>
            .prev-icon {
                background-position: 0 -24px;
                height: 45px;
                margin-left: 20px;
            }
            .next-icon {
                background-position: -28px -24px;
                left: 100%;
                margin-left: -50px;
            }
            .icon {
                background-image: url(http://www.facebook.com/rsrc.php/v2/y6/r/GONRI32j6zQ.png);
                background-repeat: no-repeat;
                background-size: 64px 323px;
                width: 27px;
                height: 45px;
                display: block;
                position: absolute;
                top: 50%;
                margin-top: -22px;
                opacity: .1;
                transition: opacity 0.5s;
            }
            .navigation-underlay {
                height: 100%;
                display: block;
                width: 300px;
                position: absolute;
                top: 0;
            }
            .next {
                right: 0;
            }
            .lightbox {
                width: 100%;
                height: 100%;
                position: fixed;
                background-color: rgba(0, 0, 0, .8);
                display: none;
                top: 0;
            }
            .slideshow {
                max-width: 950px;
                height: 100%;
                width: 100%;
                max-height: 650px;
                margin: auto;
                background: black;
                overflow: hidden;
                position: relative;
            }

            ul {
                height: 100%;
                width: 100%;
                padding: 0;
                margin: 0;
            }
            figure {
                width: 100%;
                height: 100%;
                display: flex;
                margin: 0px;
            }
            .slideshow img {
                max-width: 100%;
                max-height: 100%;
                margin: auto;
            }

            .slideshow li {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                display: flex;
                position: absolute;
                transition: left .15s;
            }
            .navigation-underlay:hover .icon{
                opacity: 1;
            }
        </style>
    </head>

    <body>
        <div id='tiles'></div>
        <div class="lightbox" >
        	<div class="slideshow">
                <ul class="js-slides">
                </ul>
                <a title="Previews" class="prev navigation-underlay">
                    <i class="prev-icon icon"></i>
                </a>

                <a title="Next" class="next navigation-underlay">
                    <i class="next-icon icon"></i>
                </a>
            </div>
        </div>
        <script>
            var API = {
                flickr: {
                    accuracy: 11, // means city wide
                    apiKey: '801387f8102145153e1cdd7b487e8afc',
                    loadFormat: 'json',
                    methods: {
                        search: 'flickr.photos.search',
                        getSizes: 'flickr.photos.getSizes'
                    },
                    noJsonCallback: 1,
                    reqURL: 'https://api.flickr.com/services/rest/',

                    /**
                     * Retreives flickr photos that was taken in the same city as the given lat and lon.
                     * @param {string} lat - lat.
                     * @param {string} lon - lon.
                     * @param {function} callback - callback function
                     */
                    retrievePhotosAround: function(lat, lon, page, perPage, callback) {
                        var self = this;
                        var params = {
                            accuracy: this.accuracy,
                            api_key: self.apiKey,
                            format: self.loadFormat,
                            lat: lat,
                            lon: lon,
                            method: self.methods.search,
                            page: page,
                            per_page: perPage,
                            nojsoncallback: self.noJsonCallback
                        };
                        self._makeRequest('GET', params, callback);
                    },

                    // TODO:(ganbi) once ready, change doc
                    /**
                     * Retreives flickr photos that was taken in the same city as the given lat and lon.
                     * @param {string} lat - lat.
                     * @param {string} lon - lon.
                     * @param {function} callback - callback function
                     */
                     /*
                    photo {
                        id: "23255878733",
                        owner: "96275015@N02",
                        secret: "f4524d2a12",
                        server: "586",
                        farm: 1,
                        title: "Let it rain.. Let it rain",
                        ispublic: 1,
                        isfriend: 0,
                        isfamily: 0
                    }
                     */
                    retreiveSizes: function(photo, cb) {
                        if (!photo) {
                            cb && cb(null, '1');
                        }

                        var self = this;
                        var params = {
                            api_key: self.apiKey,
                            format: self.loadFormat,
                            method: self.methods.getSizes,
                            nojsoncallback: self.noJsonCallback,
                            photo_id: photo.id
                        };

                        this._makeRequest('GET', params, cb);
                    },

                    // TODO:(ganbi) add doc when finalized
                    _makeRequest: function(method, params, callback) {
                        method = method || 'GET';
                        params = params || {};
                        var queryParams = this._constructParams(params);

                        // opens new request every time?
                        var xhttp = new XMLHttpRequest();
                        xhttp.onreadystatechange = function() {
                            if (xhttp.readyState == 4 && xhttp.status == 200) {
                                // is this safe to use?
                                var jsondata = eval('(' + xhttp.responseText + ')')
                                // TODO: (ganbi) handle error messages
                                if (callback) {
                                    callback(jsondata);
                                }
                            } else {
                                callback(null, '1');
                            }
                        };
                        xhttp.open(method, this.reqURL + queryParams, true);
                        xhttp.send();
                    },

                    _constructParams: function(params) {
                        if (!params) {
                            return '';
                        }

                        var finalParams = '?';
                        var key;
                        for (par in params) {
                            if (params.hasOwnProperty(par)) {
                                finalParams = finalParams + par + '=' + params[par] + '&';
                            }
                        }
                        return finalParams;
                    }
                }
            };
        </script>

        <script>
            // Contains the logic of populating tiles and managing lighbox slideshow
            var Gallery = {
                photos: [], // (index + 1) are the pages
                lightBoxOrder: [], // (page - 1) is the key [1 -1] = [sizes]  array order is the order wich it was adde to page.
                nextPage: 1,
                perPage: 250,

                populateTiles: function () {
                    API.flickr.retrievePhotosAround(
                        '37.7758', '122.4128',  // lat and lon
                        this.nextPage,
                        this.perPage,
                        this._afterPhotosRetrieved.bind(this) // once Photos are retrieved, uses that to retrieve sizes and renders the tiles
                    );
                },

                _afterPhotosRetrieved: function (data, error) {
                    var self = this;
                    if (data && !error) {
                        self.photos[self.nextPage - 1] = data;
                        var photos = data.photos && data.photos.photo;
                        var page = self.nextPage;
                        photos.forEach(function(photo, idx){
                            // TODO:(ganbi) change the page to var
                            API.flickr.retreiveSizes(photo,
                                function (sizes, error) {
                                    var self = this;
                                    this._afterSizesRetrieved.call(this, sizes, page, idx, error);
                                }.bind(self)
                            );
                        });
                        self.nextPage++;
                    } else if (error) {
                        // something happened;
                    }
                },

                _afterSizesRetrieved: function (data, page, photoIndx, error) {
                    if (data && !error) {
                        var pageIndx = page - 1;
                        var lbForThisPage = this.lightBoxOrder[pageIndx];
                        if (!lbForThisPage) {
                            this.lightBoxOrder[pageIndx] = [];
                        }
                        // TODO: find a better way to handle this naming
                        // TODO: what happens when you click on the image quickly when the image appears? would there be
                        //      collision of trying to load the slideshow?
                        this.photos[pageIndx].photos.photo[photoIndx].sizes = data.sizes;
                        data.photoIndx = photoIndx;
                        this.lightBoxOrder[pageIndx].push(data);
                        var ordIndx = this.lightBoxOrder[pageIndx].length - 1;
                        this._renderTile(data, page, ordIndx);
                    } else if (error) {
                        // TODO: handle errors.
                    }
                },

                _renderTile: function (data, page, ordIndx) {
                    var sizes = data.sizes.size;
                    var l = sizes.length;

                    // get the 150 square size
                    // Safari doesn't work with l => 2, but why???
                    if (l > 2 || l === 2){
                        sq150 = sizes[1];
                        if (sq150.label === 'Large Square' || sq150.label == 'Original') {
                            var tiles = document.getElementById('tiles');

                            var tempDiv = document.createElement('div');
                            // TODO:(ganbi) if it's a very small original image, the w and h won't be 150px.
                            //      leave the ratio but put it in a 150x150 container.
                            // TODO:(ganbi) use <a> tag and prevent default as when the img is
                            //      clicked, something happens.
                            // TODO:(ganbi) fix the layout, space them evenly and add max-width.
                            tempDiv.innerHTML =
                                '<img ' +
                                    'src="' + sq150.source + '" ' +
                                    'data-page="' + page + '" ' +
                                    'data-indx="' + ordIndx +'" ' +
                                    'style="' + 'width: 150px; height: 150px' + '" ' +
                                '/>';
                            tiles.appendChild(tempDiv.firstChild);
                        }
                    }
                },

                openLightbox: function (e) {
                    var targ = this._getTarget(e);
                    var page = targ.dataset.page;
                    var photoIndx = targ.dataset.indx;
                    this._loadCloseSlides(page, photoIndx);
                    document.getElementsByTagName('body')[0].style.overflow = 'hidden';
                    document.getElementsByClassName('lightbox')[0].style.display = 'flex';
                },


                // initially null
                currentSlide: {
                    node: null,
                    page: null,
                    idx: null
                },

                // num of prev slides to load not including the current
                prevLoad: 2,
                // num of next slides to load not including the current
                nextLoad: 5,
                // starts to load slides on the given img.
                _loadCloseSlides: function (page, ordIndx) {
                    // TODO: worry about going from page to page, or page ending
                    var slidesContainer = document.getElementsByClassName('js-slides')[0];

                    totalToLoad = this.prevLoad + 1 + this.nextLoad;
                    var i;
                    var tempDiv;
                    var params;
                    var currentIndex;
                    var startIndex = ordIndx - this.prevLoad;
                    if ( startIndex < 0 ) {
                        currentIndex = 0;
                    } else {
                        currentIndex = startIndex;
                    }
                    for (i = 0; i < totalToLoad; i++) {
                        params = {};
                        // TODO: normalize the sizes getting function. we're using it somewhere else as well
                        params.src = this.lightBoxOrder[page - 1][currentIndex].sizes.size[6].source; //'https://farm8.staticflickr.com/7349/9739568142_f664ff93cb_o.jpg';
                        tempDiv = document.createElement('div');
                        if (currentIndex < ordIndx) {
                            params.style = 'left: -100%;';
                        } else if (currentIndex == ordIndx) {
                            // TODO: intentially chose == for now.
                            params.style = 'left: 0;';
                        } else {
                            params.style = 'left: 100%;';
                        }

                        tempDiv.innerHTML = this._constructSlide(params);
                        slidesContainer.appendChild(tempDiv.firstChild);
                        if (currentIndex == ordIndx) {
                            // TODO: intentially chose == for now.
                            this.currentSlide = slidesContainer.lastElementChild;
                        }
                        currentIndex++;
                    }

                    console.log('initial load happened');
                },

                _loadSlides: function (page, ordIndx){

                },

                //TODO: have to add the size etc for responsive browser
                _constructSlide: function (params) {
                    if (!params) {
                        return '';
                    }
                    return (
                        '<li style="' + params.style + '">' +
                             '<figure>' +
                                '<img src="' + params.src + '">' +
                            '</figure>' +
                        '</li>'
                    )
                },

                onNextClick: function () {
                    // TODO: What happens if we're at the end of the slide?
                    // if need to load slide call load
                    var current = this.currentSlide;
                    if (!current) {
                        return;
                    }
                    var next = current.nextElementSibling;

                    current.style.left = '-100%';
                    next.style.left = '0';
                    this.currentSlide = next;
                },

                onPrevClick: function () {
                    // TODO: What happens if we're at the beginning of slides?
                    // if need to load slides call load
                    var current = this.currentSlide;
                    if (!current) {
                        return;
                    }
                    var prev = current.previousElementSibling;
                    current.style.left = '100%';
                    prev.style.left = '0';
                    this.currentSlide = prev;
                },

                closeLightbox: function (e) {
                    // remove the ul children, reset the currentSlide
                    var targ = this._getTarget(e);
                    if (targ.className === 'lightbox') {
                        document.getElementsByTagName('body')[0].style.overflow = '';
                        document.getElementsByClassName('lightbox')[0].style.display = 'none';
                        this.currentSlide.node = null;
                        this.currentSlide.page = null;
                        this.currentSlide.idx = null;
                        var slides =  document.getElementsByClassName('js-slides')[0];
                        // remove all children to reset.
                        // much faster and better than using .innerHTML = ''
                        while (slides.firstChild) {
                            slides.removeChild(slides.firstChild);
                        }
                    }
                },

                _getTarget: function (e) {
                    e = e || window.event;
                    var targ = e.target || e.srcElement;
                    // for safari
                    if (targ.nodeType == 3) {
                        targ = targ.parentNode;
                    }

                    return targ;
                },
            };
        </script>
        <script>
            // add event listener to only the parent of all tiles to use bubbling and to have less number of listeners.
            document.getElementById('tiles').addEventListener("click", Gallery.openLightbox.bind(Gallery));
            document.getElementsByClassName('lightbox')[0].addEventListener("click", Gallery.closeLightbox.bind(Gallery));
            document.getElementsByClassName('prev navigation-underlay')[0].addEventListener("click", Gallery.onPrevClick.bind(Gallery));
            document.getElementsByClassName('next navigation-underlay')[0].addEventListener("click", Gallery.onNextClick.bind(Gallery));
            Gallery.populateTiles();
        </script>
    </body>
</html>
