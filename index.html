<!DOCTYPE html>

<html>
    <head>
        <meta charset="utf-8">
        <title>Flicker Gallery</title>

        <style>
        </style>
    </head>

    <body>
        <div id='tiles'>

        </div>
        <script >
            var API = {
                flickr: {
                    accuracy: 11, // means city wide
                    apiKey: '801387f8102145153e1cdd7b487e8afc',
                    loadFormat: 'json',
                    methods: {
                        search: 'flickr.photos.search',
                        getSizes: 'flickr.photos.getSizes'
                    },
                    reqURL: 'https://api.flickr.com/services/rest/',

                    /**
                     * Retreives flickr photos that was taken in the same city as the given lat and lon.
                     * @param {string} lat - lat.
                     * @param {string} lon - lon.
                     * @param {function} callback - callback function
                     */
                    retreivePhotosAround: function(lat, lon, page, callback) {
                        var self = this;
                        var params = {
                            accuracy: this.accuracy,
                            api_key: self.apiKey,
                            format: self.loadFormat,
                            lat: lat,
                            lon: lon,
                            method: self.methods.search,
                            page: page,
                            per_page: 100,
                            nojsoncallback: 1
                        };
                        self._makeRequest('GET', params, callback);
                    },

                    // TODO:(ganbi) once ready, change doc
                    /**
                     * Retreives flickr photos that was taken in the same city as the given lat and lon.
                     * @param {string} lat - lat.
                     * @param {string} lon - lon.
                     * @param {function} callback - callback function
                     */
                    retreiveSizes: function(photo, page, callback) {
                        if (!photo) {
                            callback && callback(null, '1');
                        }

                        var self = this;
                        var params = {
                            api_key: self.apiKey,
                            format: self.loadFormat,
                            method: self.methods.getSizes,
                            nojsoncallback: 1,
                            photo_id: photo.id
                        };
                        var cb = function (data1)  {
                            callback(photo, data1, page);
                        };

                        this._makeRequest('GET', params, cb);
                    },

                    // TODO:(ganbi) add doc when finalized
                    _makeRequest: function(method, params, callback) {
                        method = method || 'GET';
                        params = params || {};
                        var queryParams = this._constructParams(params);

                        // opens new request every time?
                        var xhttp = new XMLHttpRequest();
                        xhttp.onreadystatechange = function() {
                            if (xhttp.readyState == 4 && xhttp.status == 200) {
                                // is this safe to use?
                                var jsondata = eval('(' + xhttp.responseText + ')')
                                // TODO: (ganbi) handle error messages
                                if (callback) {
                                    callback(jsondata);
                                }
                            }
                        };
                        xhttp.open(method, this.reqURL + queryParams, true);
                        xhttp.send();
                    },

                    _constructParams: function(params) {
                        if (!params) {
                            return '';
                        }

                        var finalParams = '?';
                        var key;
                        for (par in params) {
                            if (params.hasOwnProperty(par)) {
                                finalParams = finalParams + par + '=' + params[par] + '&';
                            }
                        }
                        return finalParams;
                    }
                }
                // google api, yahoo api etc
            };

            API.flickr.retreivePhotosAround('37.7758', '122.4128', 1, function(data, error) {
                if (data && !error) {

                    var photos = data.photos && data.photos.photo;
                    photos.forEach(function(photo, inx){
                        var renderTiles = function(photo, data, page) {
                            photo.sizes = data; // photo.sizes.sizes
                            var sizes = data.sizes.size;
                            var l = sizes.length;

                            // get the 150 square size
                            if (l > 2 || l === 2){
                                sq150 = sizes[1];
                                if (sq150.label === 'Large Square' || sq150.label == 'Original') {
                                    var tiles = document.getElementById('tiles');

                                    var tempDiv = document.createElement('div');
                                    tempDiv.innerHTML =
                                        '<img ' +
                                            'src="' + sq150.source + '" ' +
                                            'data-page="' + page + '" ' +
                                            'data-index="' + inx +'" ' +
                                            'style="' + 'width: 150px; height: 150px' + '" ' +
                                        '/>';
                                    tiles.appendChild(tempDiv.firstChild);
                                }
                            }
                            console.log('here is my sizes');
                            console.log(data);
                            console.log(photo);
                        }
                        // TODO:(ganbi) change the page to var
                        API.flickr.retreiveSizes(photo, 1, renderTiles);
                    });
                    console.log(data);
                } else if (error) {
                    // something happened;
                }

                        /*var l = photos.length;
                        var i;
                        for (i = 0; i < l; i++){
                            var photo = photophotos[i];
                        }*/

                setTimeout(function() {
                    console.log('data after getting sizes');
                    console.log(data);
                }, 1000);
            });
        </script>

    </body>
</html>

<!--
https://api.flickr.com/services/rest/?
method=flickr.photos.search&
api_key=801387f8102145153e1cdd7b487e8afc&
accuracy=11&
lat=37.7758&
lon=122.4128&
page=1&
format=json&
per_page



"https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key=fd83245708c9c8639e9797c9ebed1a03&accuracy=11&lat=37.7758&lon=122.4128&page=1&format=json&nojsoncallback=1", true);

-->
