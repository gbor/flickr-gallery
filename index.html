<!DOCTYPE html>

<html>
    <head>
        <meta charset="utf-8">
        <title>Flicker Gallery</title>
        <style>
            .prev-icon {
                background-position: 0 -24px;
                height: 45px;
                margin-left: 20px;
            }
            .next-icon {
                background-position: -28px -24px;
                left: 100%;
                margin-left: -50px;
            }
            .icon {
                background-image: url(http://www.facebook.com/rsrc.php/v2/y6/r/GONRI32j6zQ.png);
                background-repeat: no-repeat;
                background-size: 64px 323px;
                width: 27px;
                height: 45px;
                display: block;
                position: absolute;
                top: 50%;
                margin-top: -22px;
                opacity: .1;
                transition: opacity 0.2s linear;
            }
            .navigation-underlay {
                height: 100%;
                display: block;
                width: 300px;
                position: absolute;
                top: 0;
            }
            .next {
                right: 0;
            }
            .lightbox {
                width: 100%;
                height: 100%;
                position: fixed;
                background-color: rgba(0, 0, 0, .8);
                display: none;
                top: 0;
            }
            .slideshow {
                max-width: 950px;
                height: 100%;
                width: 100%;
                max-height: 650px;
                margin: auto;
                background: black;
                overflow: hidden;
                position: relative;
            }

            ul {
                height: 100%;
                width: 100%;
                padding: 0;
                margin: 0;
            }
            figure {
                width: 100%;
                height: 100%;
                display: flex;
                display: -webkit-flex;
                margin: 0px;
            }
            .slideshow img {
                max-width: 100%;
                max-height: 100%;
                margin: auto;
            }

            .slideshow li {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                display: flex;
                display: -webkit-flex;
                position: absolute;
                transition: left .15s;
            }
            .navigation-underlay:hover .icon{
                opacity: 1;
            }

            .D\(flex\) {
                display: flex;
                display: -webkit-flex;
            }

            .spinner {
                display: none;
                position: fixed;
                right: 50%;
                top: -100%;
                height: 100px;
                width: 100px;
                margin-right: -50px;
                margin-top: -50px;
                background-color: rgba(25, 25, 25, .9);
                background-image: url("data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSItMjUgLTI1IDEwMCAxMDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGc+PHBhdGggZD0iTTI1IDBhMjUgMjUgMCAwIDAgMCA1MCIgc3Ryb2tlLWRhc2hhcnJheT0iNzkiIHN0cm9rZT0iI2FhYSIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiIGZpbGw9Im5vbmUiPjxhbmltYXRlIGlkPSJhMSIgYXR0cmlidXRlVHlwZT0iWE1MIiBhdHRyaWJ1dGVOYW1lPSJzdHJva2UtZGFzaG9mZnNldCIgZnJvbT0iOSIgdG89Ijc2IiBkdXI9Ijc1MG1zIiBiZWdpbj0iMHM7IGEyLmVuZCIgZmlsbD0iZnJlZXplIiBjYWxjTW9kZT0ic3BsaW5lIiBrZXlUaW1lcz0iMDsxIiBrZXlTcGxpbmVzPSIwLjIxNSwgMC42MSwgMC4zNTUsIDEiLz48YW5pbWF0ZSBpZD0iYTIiIGF0dHJpYnV0ZVR5cGU9IlhNTCIgYXR0cmlidXRlTmFtZT0ic3Ryb2tlLWRhc2hvZmZzZXQiIGZyb209Ijc2IiB0bz0iOSIgZHVyPSI3NTBtcyIgYmVnaW49ImExLmVuZCIgZmlsbD0iZnJlZXplIiBjYWxjTW9kZT0ic3BsaW5lIiBrZXlUaW1lcz0iMDsxIiBrZXlTcGxpbmVzPSIwLjIxNSwgMC42MSwgMC4zNTUsIDEiLz48YW5pbWF0ZSBpZD0iYTMiIGF0dHJpYnV0ZVR5cGU9IlhNTCIgYXR0cmlidXRlTmFtZT0ic3Ryb2tlLXdpZHRoIiBmcm9tPSI0IiB0bz0iOCIgZHVyPSI3NTBtcyIgYmVnaW49IjBzOyBhNC5lbmQiIGZpbGw9ImZyZWV6ZSIgY2FsY01vZGU9InNwbGluZSIga2V5VGltZXM9IjA7MSIga2V5U3BsaW5lcz0iMC4yMTUsIDAuNjEsIDAuMzU1LCAxIi8+PGFuaW1hdGUgaWQ9ImE0IiBhdHRyaWJ1dGVUeXBlPSJYTUwiIGF0dHJpYnV0ZU5hbWU9InN0cm9rZS13aWR0aCIgZnJvbT0iOCIgdG89IjQiIGR1cj0iNzUwbXMiIGJlZ2luPSJhMy5lbmQiIGZpbGw9ImZyZWV6ZSIgY2FsY01vZGU9InNwbGluZSIga2V5VGltZXM9IjA7MSIga2V5U3BsaW5lcz0iMC4yMTUsIDAuNjEsIDAuMzU1LCAxIi8+PGFuaW1hdGVUcmFuc2Zvcm0gaWQ9ImE1IiBhdHRyaWJ1dGVUeXBlPSJYTUwiIGF0dHJpYnV0ZU5hbWU9InRyYW5zZm9ybSIgdHlwZT0icm90YXRlIiBmcm9tPSIwIDI1IDI1IiB0bz0iMCAyNSAyNSIgZHVyPSI3NTBtcyIgYmVnaW49IjA7IGE4LmVuZCIgY2FsY01vZGU9InNwbGluZSIga2V5VGltZXM9IjA7MSIga2V5U3BsaW5lcz0iMC4yMTUsIDAuNjEsIDAuMzU1LCAxIi8+PGFuaW1hdGVUcmFuc2Zvcm0gaWQ9ImE2IiBhdHRyaWJ1dGVUeXBlPSJYTUwiIGF0dHJpYnV0ZU5hbWU9InRyYW5zZm9ybSIgdHlwZT0icm90YXRlIiBmcm9tPSIwIDI1IDI1IiB0bz0iMTgwIDI1IDI1IiBkdXI9Ijc1MG1zIiBiZWdpbj0iYTUuZW5kIiBjYWxjTW9kZT0ic3BsaW5lIiBrZXlUaW1lcz0iMDsxIiBrZXlTcGxpbmVzPSIwLjIxNSwgMC42MSwgMC4zNTUsIDEiLz48YW5pbWF0ZVRyYW5zZm9ybSBpZD0iYTciIGF0dHJpYnV0ZVR5cGU9IlhNTCIgYXR0cmlidXRlTmFtZT0idHJhbnNmb3JtIiB0eXBlPSJyb3RhdGUiIGZyb209IjE4MCAyNSAyNSIgdG89IjE4MCAyNSAyNSIgZHVyPSI3NTBtcyIgYmVnaW49ImE2LmVuZCIgY2FsY01vZGU9InNwbGluZSIga2V5VGltZXM9IjA7MSIga2V5U3BsaW5lcz0iMC4yMTUsIDAuNjEsIDAuMzU1LCAxIi8+PGFuaW1hdGVUcmFuc2Zvcm0gaWQ9ImE4IiBhdHRyaWJ1dGVUeXBlPSJYTUwiIGF0dHJpYnV0ZU5hbWU9InRyYW5zZm9ybSIgdHlwZT0icm90YXRlIiBmcm9tPSIxODAgMjUgMjUiIHRvPSIzNjAgMjUgMjUiIGR1cj0iNzUwbXMiIGJlZ2luPSJhNy5lbmQiIGNhbGNNb2RlPSJzcGxpbmUiIGtleVRpbWVzPSIwOzEiIGtleVNwbGluZXM9IjAuMjE1LCAwLjYxLCAwLjM1NSwgMSIvPjwvcGF0aD48cGF0aCBkPSJNMjUgNTBhMjUgMjUgMCAxIDAgMC01MCIgc3Ryb2tlLWRhc2hhcnJheT0iNzkiIHN0cm9rZT0iI2FhYSIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiIGZpbGw9Im5vbmUiPjxhbmltYXRlIGF0dHJpYnV0ZVR5cGU9IlhNTCIgYXR0cmlidXRlTmFtZT0ic3Ryb2tlLWRhc2hvZmZzZXQiIGZyb209IjkiIHRvPSI3NiIgZHVyPSI3NTBtcyIgYmVnaW49IjBzOyBhMi5lbmQiIGZpbGw9ImZyZWV6ZSIgY2FsY01vZGU9InNwbGluZSIga2V5VGltZXM9IjA7MSIga2V5U3BsaW5lcz0iMC4yMTUsIDAuNjEsIDAuMzU1LCAxIi8+PGFuaW1hdGUgYXR0cmlidXRlVHlwZT0iWE1MIiBhdHRyaWJ1dGVOYW1lPSJzdHJva2UtZGFzaG9mZnNldCIgZnJvbT0iNzYiIHRvPSI5IiBkdXI9Ijc1MG1zIiBiZWdpbj0iYTEuZW5kIiBmaWxsPSJmcmVlemUiIGNhbGNNb2RlPSJzcGxpbmUiIGtleVRpbWVzPSIwOzEiIGtleVNwbGluZXM9IjAuMjE1LCAwLjYxLCAwLjM1NSwgMSIvPjxhbmltYXRlIGF0dHJpYnV0ZVR5cGU9IlhNTCIgYXR0cmlidXRlTmFtZT0ic3Ryb2tlLXdpZHRoIiBmcm9tPSI0IiB0bz0iOCIgZHVyPSI3NTBtcyIgYmVnaW49IjBzOyBhNC5lbmQiIGZpbGw9ImZyZWV6ZSIgY2FsY01vZGU9InNwbGluZSIga2V5VGltZXM9IjA7MSIga2V5U3BsaW5lcz0iMC4yMTUsIDAuNjEsIDAuMzU1LCAxIi8+PGFuaW1hdGUgYXR0cmlidXRlVHlwZT0iWE1MIiBhdHRyaWJ1dGVOYW1lPSJzdHJva2Utd2lkdGgiIGZyb209IjgiIHRvPSI0IiBkdXI9Ijc1MG1zIiBiZWdpbj0iYTMuZW5kIiBmaWxsPSJmcmVlemUiIGNhbGNNb2RlPSJzcGxpbmUiIGtleVRpbWVzPSIwOzEiIGtleVNwbGluZXM9IjAuMjE1LCAwLjYxLCAwLjM1NSwgMSIvPjxhbmltYXRlVHJhbnNmb3JtIGF0dHJpYnV0ZVR5cGU9IlhNTCIgYXR0cmlidXRlTmFtZT0idHJhbnNmb3JtIiB0eXBlPSJyb3RhdGUiIGZyb209IjAgMjUgMjUiIHRvPSIwIDI1IDI1IiBkdXI9Ijc1MG1zIiBiZWdpbj0iMDsgYTguZW5kIiBjYWxjTW9kZT0ic3BsaW5lIiBrZXlUaW1lcz0iMDsxIiBrZXlTcGxpbmVzPSIwLjIxNSwgMC42MSwgMC4zNTUsIDEiLz48YW5pbWF0ZVRyYW5zZm9ybSBhdHRyaWJ1dGVUeXBlPSJYTUwiIGF0dHJpYnV0ZU5hbWU9InRyYW5zZm9ybSIgdHlwZT0icm90YXRlIiBmcm9tPSIwIDI1IDI1IiB0bz0iMTgwIDI1IDI1IiBkdXI9Ijc1MG1zIiBiZWdpbj0iYTUuZW5kIiBjYWxjTW9kZT0ic3BsaW5lIiBrZXlUaW1lcz0iMDsxIiBrZXlTcGxpbmVzPSIwLjIxNSwgMC42MSwgMC4zNTUsIDEiLz48YW5pbWF0ZVRyYW5zZm9ybSBhdHRyaWJ1dGVUeXBlPSJYTUwiIGF0dHJpYnV0ZU5hbWU9InRyYW5zZm9ybSIgdHlwZT0icm90YXRlIiBmcm9tPSIxODAgMjUgMjUiIHRvPSIxODAgMjUgMjUiIGR1cj0iNzUwbXMiIGJlZ2luPSJhNi5lbmQiIGNhbGNNb2RlPSJzcGxpbmUiIGtleVRpbWVzPSIwOzEiIGtleVNwbGluZXM9IjAuMjE1LCAwLjYxLCAwLjM1NSwgMSIvPjxhbmltYXRlVHJhbnNmb3JtIGlkPSJhOCIgYXR0cmlidXRlVHlwZT0iWE1MIiBhdHRyaWJ1dGVOYW1lPSJ0cmFuc2Zvcm0iIHR5cGU9InJvdGF0ZSIgZnJvbT0iMTgwIDI1IDI1IiB0bz0iMzYwIDI1IDI1IiBkdXI9Ijc1MG1zIiBiZWdpbj0iYTcuZW5kIiBjYWxjTW9kZT0ic3BsaW5lIiBrZXlUaW1lcz0iMDsxIiBrZXlTcGxpbmVzPSIwLjIxNSwgMC42MSwgMC4zNTUsIDEiLz48L3BhdGg+PGFuaW1hdGVUcmFuc2Zvcm0gYXR0cmlidXRlVHlwZT0iWE1MIiBhdHRyaWJ1dGVOYW1lPSJ0cmFuc2Zvcm0iIHR5cGU9InJvdGF0ZSIgZnJvbT0iMCAyNSAyNSIgdG89IjM2MCAyNSAyNSIgZHVyPSI2NzUwbXMiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIi8+PC9nPjwvc3ZnPg==");
            }
        </style>
    </head>

    <body onscroll="scrolled(this)">
        <div id="tiles"></div>
        <div class="lightbox" >
        	<div class="slideshow">
                <ul class="js-slides">
                </ul>
                <a title="Previews" class="prev navigation-underlay">
                    <i class="prev-icon icon"></i>
                </a>

                <a title="Next" class="next navigation-underlay">
                    <i class="next-icon icon"></i>
                </a>
            </div>
        </div>
        <div class="spinner js-spinner"> </div>
        <script>
            var API = {
                flickr: {
                    accuracy: 11, // means city wide
                    apiKey: '801387f8102145153e1cdd7b487e8afc',
                    loadFormat: 'json',
                    methods: {
                        search: 'flickr.photos.search',
                        getSizes: 'flickr.photos.getSizes'
                    },
                    noJsonCallback: 1,
                    reqURL: 'https://api.flickr.com/services/rest/',

                    /**
                     * Retreives flickr photos that was taken in the same city as the given lat and lon.
                     * @param {string} lat - lat.
                     * @param {string} lon - lon.
                     * @param {function} callback - callback function
                     */
                    retrievePhotosAround: function(lat, lon, page, perPage, callback) {
                        var self = this;
                        var params = {
                            accuracy: this.accuracy,
                            api_key: self.apiKey,
                            format: self.loadFormat,
                            lat: lat,
                            lon: lon,
                            method: self.methods.search,
                            page: page,
                            per_page: perPage,
                            nojsoncallback: self.noJsonCallback
                        };
                        self._makeRequest('GET', params, callback);
                    },

                    // TODO:(ganbi) once ready, change doc
                    /**
                     * Retreives flickr photos that was taken in the same city as the given lat and lon.
                     * @param {string} lat - lat.
                     * @param {string} lon - lon.
                     * @param {function} callback - callback function
                     */
                     /*
                    photo {
                        id: "23255878733",
                        owner: "96275015@N02",
                        secret: "f4524d2a12",
                        server: "586",
                        farm: 1,
                        title: "Let it rain.. Let it rain",
                        ispublic: 1,
                        isfriend: 0,
                        isfamily: 0
                    }
                     */
                    retreiveSizes: function(photo, cb) {
                        if (!photo) {
                            cb && cb(null, '1');
                        }

                        var self = this;
                        var params = {
                            api_key: self.apiKey,
                            format: self.loadFormat,
                            method: self.methods.getSizes,
                            nojsoncallback: self.noJsonCallback,
                            photo_id: photo.id
                        };

                        this._makeRequest('GET', params, cb);
                    },

                    // TODO:(ganbi) add doc when finalized
                    _makeRequest: function(method, params, callback) {
                        method = method || 'GET';
                        params = params || {};
                        var queryParams = this._constructParams(params);

                        // opens new request every time?
                        var xhttp = new XMLHttpRequest();
                        xhttp.onreadystatechange = function() {
                            if (xhttp.readyState == 4 && xhttp.status == 200) {
                                // is this safe to use?
                                var jsondata = eval('(' + xhttp.responseText + ')')
                                // TODO: (ganbi) handle error messages
                                if (callback) {
                                    callback(jsondata);
                                }
                            } else {
                                callback(null, '1');
                            }
                        };
                        xhttp.open(method, this.reqURL + queryParams, true);
                        xhttp.send();
                    },

                    _constructParams: function(params) {
                        if (!params) {
                            return '';
                        }

                        var finalParams = '?';
                        var key;
                        for (par in params) {
                            if (params.hasOwnProperty(par)) {
                                finalParams = finalParams + par + '=' + params[par] + '&';
                            }
                        }
                        return finalParams;
                    }
                }
            };
        </script>
        <script>
            // Contains the logic of populating tiles and managing lighbox slideshow
            // TODO: might need to add Webkit for some styles?
            var Gallery = {
                photos: [], // (index + 1) are the pages
                lightBoxOrder: [], // (page - 1) is the key [1 -1] = [sizes]  array order is the order wich it was adde to page.
                nextPage: 1,
                perPage: 250,

                populateTiles: function () {
                    this.addSpinner();
                    API.flickr.retrievePhotosAround(
                        '37.7758', '122.4128',  // lat and lon
                        this.nextPage,
                        this.perPage,
                        this._afterPhotosRetrieved.bind(this) // once Photos are retrieved, uses that to retrieve sizes and renders the tiles
                    );
                },

                _afterPhotosRetrieved: function (data, error) {
                    var self = this;
                    if (data && !error) {
                        self.photos[self.nextPage - 1] = data;
                        var photos = data.photos && data.photos.photo;
                        var page = self.nextPage;
                        photos.forEach(function(photo, idx){
                            // TODO:(ganbi) change the page to var
                            API.flickr.retreiveSizes(photo,
                                function (sizes, error) {
                                    var self = this;
                                    this._afterSizesRetrieved.call(this, sizes, page, idx, error);
                                }.bind(self)
                            );
                        });
                        this.closeSpinner();
                        self.nextPage++;
                    } else if (error) {
                        // something happened;
                    }
                },

                addSpinner: function () {
                    var spinnerNode = document.getElementsByClassName('js-spinner')[0];
                    spinnerNode.style.display = 'block';
                    spinnerNode.style.top = '50%';
                },

                closeSpinner: function () {
                    var spinnerNode = document.getElementsByClassName('js-spinner')[0];
                    spinnerNode.style.display = '';
                    spinnerNode.style.top = '';
                },

                _afterSizesRetrieved: function (data, page, photoIndx, error) {
                    if (data && !error) {
                        var pageIndx = page - 1;
                        var lbForThisPage = this.lightBoxOrder[pageIndx];
                        if (!lbForThisPage) {
                            this.lightBoxOrder[pageIndx] = [];
                        }
                        // TODO: find a better way to handle this naming
                        this.photos[pageIndx].photos.photo[photoIndx].sizes = data.sizes;
                        data.photoIndx = photoIndx;
                        this.lightBoxOrder[pageIndx].push(data);
                        var ordIndx = this.lightBoxOrder[pageIndx].length - 1;
                        this._renderTile(data, page, ordIndx);
                    } else if (error) {
                        // TODO: handle errors.
                    }
                },

                _renderTile: function (data, page, ordIndx) {
                    var sizes = data.sizes.size;
                    var l = sizes.length;

                    // get the 150 square size
                    // Safari doesn't work with l ==> 2, what?
                    if (l > 2 || l === 2){
                        sq150 = sizes[1];
                        if (sq150.label === 'Large Square' || sq150.label == 'Original') {
                            var tiles = document.getElementById('tiles');

                            var tempDiv = document.createElement('div');
                            // TODO:(ganbi) if it's a very small original image, the w and h won't be 150px.
                            //      leave the ratio but put it in a 150x150 container.
                            // TODO:(ganbi) use <a> tag and prevent default as when the img is
                            //      clicked, something happens.
                            // TODO:(ganbi) fix the layout, space them evenly and add max-width.
                            tempDiv.innerHTML =
                                '<img ' +
                                    'src="' + sq150.source + '" ' +
                                    'data-page="' + page + '" ' +
                                    'data-indx="' + ordIndx + '" ' +
                                    'style="' + 'width: 150px; height: 150px' + '" ' +
                                '/>';
                            tiles.appendChild(tempDiv.firstChild);
                        }
                    }
                },

                openLightbox: function (e) {
                    var targ = this._getTarget(e);
                    var page = targ.dataset.page;
                    var photoIndx = targ.dataset.indx;
                    this.currentSlide.page = page;
                    this.currentSlide.idx = photoIndx;
                    var startIndex = photoIndx - this.prevLoad;
                    var numOfSlides = this.prevLoad + this.nextLoad + 1;
                    this._loadSlides(startIndex, numOfSlides);
                    document.getElementsByTagName('body')[0].style.overflow = 'hidden';
                    document.getElementsByClassName('lightbox')[0].className += ' D(flex)';
                },
                // should be null initially, leaving them for self documentation
                currentSlide: {
                    node: null,
                    page: null,
                    idx: null
                },

                // num of prev slides to load not including the current initially. initially === everytime lb opens
                prevLoad: 2,
                // num of next slides to load not including the current initially. initially === everytime lb opens
                nextLoad: 5,
                // starts to load slides on the given img.
                // start index is inclusive
                _loadSlides: function (startIndex, numOfSlides, isPrepend) {
                    // TODO: worry about going from page to page, or page ending
                    // TODO: change indx to idx
                    var slidesContainer = document.getElementsByClassName('js-slides')[0];

                    var ordIndx = this.currentSlide.idx;
                    var i;
                    var tempDiv;
                    var params;
                    var currentIndex;
                    // TODO: or if start index is bigger than the available widh??
                    // TODO: on the two edge when we run into another page?
                    // TODO: startindex is inclusive so check that.
                    if ( isPrepend && startIndex < 0 ) {
                        return true;
                    } else if (startIndex < 0) {
                        currentIndex = 0;
                    } else {
                        currentIndex = startIndex
                    }

                    for (i = 0; i < numOfSlides; i++) {
                        params = {};
                        // TODO: normalize the sizes getting function. we're using it somewhere else as well
                        // TODO: change num 6 to a getter function
                        if (!this.lightBoxOrder[this.currentSlide.page - 1][currentIndex]) {
                            // change page breaking for now
                            return true;
                        }

                        var chosenPhoto = 6;
                        if ( this.lightBoxOrder[this.currentSlide.page - 1][currentIndex].sizes.size.length < 7 ) {
                            chosenPhoto = this.lightBoxOrder[this.currentSlide.page - 1][currentIndex].sizes.size.length - 1;
                        }
                        params.src = this.lightBoxOrder[this.currentSlide.page - 1][currentIndex].sizes.size[chosenPhoto].source; //'https://farm8.staticflickr.com/7349/9739568142_f664ff93cb_o.jpg';
                        // TODO: when it goes to the next page this page have to change and cannot stay the same
                        params.page = this.currentSlide.page;
                        params.idx = currentIndex;
                        if (currentIndex < ordIndx) {
                            params.style = 'left: -100%;';
                        } else if (currentIndex == ordIndx) {
                            // TODO: intentially chose == for now.
                            params.style = 'left: 0;';
                        } else {
                            params.style = 'left: 100%;';
                        }

                        tempDiv = document.createElement('div');
                        tempDiv.innerHTML = this._constructSlide(params);


                        if (isPrepend) {
                            slidesContainer.insertBefore(tempDiv.firstChild, slidesContainer.childNodes[0]);
                        }  else {
                            slidesContainer.appendChild(tempDiv.firstChild);
                        }

                        if (currentIndex == ordIndx) {
                            // TODO: intentially chose == for now.
                            this.currentSlide.node = slidesContainer.lastElementChild;
                        }

                        if (isPrepend) {
                            currentIndex--;
                        }  else {
                            currentIndex++;
                        }
                    }
                },

                //TODO: have to add the size etc for responsive browser
                _constructSlide: function (params) {
                    if (!params) {
                        return '';
                    }
                    return (
                        '<li ' +
                            'style="' + params.style + '" ' +
                            'data-page="' + params.page + '" ' +
                            'data-indx="' + params.idx + '" ' +
                        '>' +
                             '<figure>' +
                                '<img src="' + params.src + '">' +
                            '</figure>' +
                        '</li>'
                    )
                },

                onNextClick: function () {
                    // TODO: What happens if we're at the end of the slide?
                    // if need to load slide call load
                    var current = this.currentSlide.node;
                    if (!current) {
                        return;
                    }
                    var next = current.nextElementSibling;

                    if (!next) {
                        return;
                    }

                    current.style.left = '-100%';
                    next.style.left = '0';
                    var oneBeforeLast;
                    if (!this.currentSlide.oneBeforeLast && !next.nextElementSibling.nextElementSibling) {
                        oneBeforeLast = this._loadSlides(parseInt(next.nextElementSibling.dataset.indx, 10) + 1, 6);
                    }
                    // TODO: need to change page as well here
                    this.currentSlide.node = next;
                    this.currentSlide.idx = next.dataset.indx;
                    this.currentSlide.page = next.dataset.page;
                    this.currentSlide.oneBeforeLast = oneBeforeLast;
                    // TODO: make the button disapper when no more
                },

                onPrevClick: function () {
                    // TODO: What happens if we're at the beginning of slides?
                    // if need to load slides call load
                    var current = this.currentSlide.node;
                    if (!current) {
                        return;
                    }
                    var prev = current.previousElementSibling;
                    if (!prev) {
                        return;
                    }
                    current.style.left = '100%';
                    prev.style.left = '0';
                    // if prev slide before this is not loaded, load 6 more at the beginning.
                    var secondSlide;
                    if (!this.currentSlide.secondSlide && !prev.previousElementSibling.previousElementSibling) {
                        secondSlide = this._loadSlides(parseInt(prev.previousElementSibling.dataset.indx, 10) - 1, 6, true);
                    }
                    // TODO: need to change page as well here
                    this.currentSlide.node = prev;
                    this.currentSlide.idx = prev.dataset.indx;
                    this.currentSlide.page = prev.dataset.page;
                    this.currentSlide.secondSlide = secondSlide;
                    // TODO: make the button disapper when no more
                },

                closeLightbox: function (e) {
                    // remove the ul children, reset the currentSlide
                    var targ = this._getTarget(e);

                    if ( targ.className.indexOf('lightbox') > -1 ) {
                        document.getElementsByTagName('body')[0].style.overflow = '';
                        document.getElementsByClassName('lightbox')[0].className = 'lightbox';
                        this.currentSlide.node = null;
                        this.currentSlide.page = null;
                        this.currentSlide.idx = null;
                        var slides =  document.getElementsByClassName('js-slides')[0];
                        // remove all children to reset.
                        // much faster and better than using .innerHTML = ''
                        while (slides.firstChild) {
                            slides.removeChild(slides.firstChild);
                        }
                    }
                },

                _getTarget: function (e) {
                    e = e || window.event;
                    var targ = e.target || e.srcElement;
                    // for safari
                    if (targ.nodeType == 3) {
                        targ = targ.parentNode;
                    }

                    return targ;
                },

                isPagesComplete: function () {
                    var photos = this.photos;
                    if (photos && photos.length > 0) {
                        var l = photos.length;
                        var lastPage = photos[l - 1];
                        var lastLoadedPage = lastPage.photos.page;
                        var availablePages = lastPage.photos.pages;
                        if (lastLoadedPage === availablePages || lastLoadedPage > availablePages) {
                            return true;
                        }
                    }
                    return false;
                }
            };
        </script>
        <script>
            // add event listener to only the parent of all tiles to use bubbling and to have less number of listeners.
            // TODO: better way to handle the bind?
            document.getElementById('tiles').addEventListener("click", Gallery.openLightbox.bind(Gallery));
            document.getElementsByClassName('lightbox')[0].addEventListener("click", Gallery.closeLightbox.bind(Gallery));
            document.getElementsByClassName('prev')[0].addEventListener("click", Gallery.onPrevClick.bind(Gallery));
            document.getElementsByClassName('next')[0].addEventListener("click", Gallery.onNextClick.bind(Gallery));
            Gallery.populateTiles();
            window.onscroll = function() {
                // var buffer = 150; // px
                var d = document.documentElement;
                var offset = (d.scrollTop || window.pageYOffset) + window.innerHeight;
                var height = d.offsetHeight;
                if (offset === height && !Gallery.isPagesComplete()) {
                    Gallery.populateTiles();
                }
            };
        </script>
    </body>
</html>
